#Load Libraries
library(data.table)
library(rpart)
library(randomForest)
library(bartMachine)
library(tree)
library(rattle)
library(RColorBrewer)

#Load Data
training <- fread("train.csv/train.csv")
testing <- fread("test.csv/test.csv")
testing$Response <- NA

#Missing Data?
na_omit_training <- na.omit(training) #Cannot omit missing data

#Random Forest?
all_data <- as.data.frame(mapply(c, training, testing))

#Find out which columns have missing data
summary(all_data)

#Summary shows which columns has NA values

#Columns with NA's
#Employment_Info_1, 4, 6; Insurance_History_5; Family_Hist_2:5;
#Medical_History_1,10, 15, 24, 32; Response (not really 'missing data')

#Filling in Missing Data
#Use all variables excluding those with NA values
predicted_emp_info_1 <- 
  rpart(Employment_Info_1 ~ . - Employment_Info_4 -
          Employment_Info_6 - Insurance_History_5 - Family_Hist_2 -
          Family_Hist_3 - Family_Hist_4 - Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Employment_Info_1),], 
        method = "anova")

training$Employment_Info_1[is.na(training$Employment_Info_1)] <- 
  predict(predicted_emp_info_1, training[is.na(training$Employment_Info_1)])

predicted_emp_info_4 <- 
  rpart(Employment_Info_4 ~ . -
          Employment_Info_6 - Insurance_History_5 - Family_Hist_2 -
          Family_Hist_3 - Family_Hist_4 - Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Employment_Info_4),], 
        method = "anova")

training$Employment_Info_4[is.na(training$Employment_Info_4)] <- 
  predict(predicted_emp_info_4, training[is.na(training$Employment_Info_4)])

predicted_emp_info_6 <- 
  rpart(Employment_Info_4 ~ . - Insurance_History_5 - Family_Hist_2 -
          Family_Hist_3 - Family_Hist_4 - Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Employment_Info_6),], 
        method = "anova")

training$Employment_Info_6[is.na(training$Employment_Info_6)] <- 
  predict(predicted_emp_info_6, training[is.na(training$Employment_Info_6)])

predicted_ins_hist_5 <- 
  rpart(Insurance_History_5 ~ . - Family_Hist_2 -
          Family_Hist_3 - Family_Hist_4 - Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Insurance_History_5),], 
        method = "anova")

training$Insurance_History_5[is.na(training$Insurance_History_5)] <- 
  predict(predicted_ins_hist_5, training[is.na(training$Insurance_History_5)])

predicted_fam_hist_2 <- 
  rpart(Family_Hist_2 ~ . - Family_Hist_3 - Family_Hist_4 - 
          Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Family_Hist_2),], 
        method = "anova")

training$Family_Hist_2[is.na(training$Family_Hist_2)] <- 
  predict(predicted_fam_hist_2, training[is.na(training$Family_Hist_2)])

predicted_fam_hist_3 <- 
  rpart(Family_Hist_3 ~ . - Family_Hist_4 - 
          Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Family_Hist_3),], 
        method = "anova")

training$Family_Hist_3[is.na(training$Family_Hist_3)] <- 
  predict(predicted_fam_hist_3, training[is.na(training$Family_Hist_3)])

predicted_fam_hist_4 <- 
  rpart(Family_Hist_4 ~ . - Family_Hist_5 - Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Family_Hist_4),], 
        method = "anova")

training$Family_Hist_4[is.na(training$Family_Hist_4)] <- 
  predict(predicted_fam_hist_4, training[is.na(training$Family_Hist_4)])

predicted_fam_hist_5 <- 
  rpart(Family_Hist_5 ~ .- Medical_History_1 -
          Medical_History_10 - Medical_History_15 - Medical_History_24 -
          Medical_History_32, 
        data = training[!is.na(training$Family_Hist_5),], 
        method = "anova")

training$Family_Hist_5[is.na(training$Family_Hist_5)] <- 
  predict(predicted_fam_hist_5, training[is.na(training$Family_Hist_5)])

predicted_med_hist_1 <- 
  rpart(Medical_History_1 ~ . - Medical_History_10 - Medical_History_15 - 
          Medical_History_24 - Medical_History_32, 
        data = training[!is.na(training$Medical_History_1),], 
        method = "class")

training$Medical_History_1[is.na(training$Medical_History_1)] <- 
  predict(predicted_med_hist_1, training[is.na(training$Medical_History_1)])

subset_medhist10 <- subset(training, select = -3)

predicted_med_hist_10 <- 
  rpart(Medical_History_10 ~ . - Medical_History_15 - 
          Medical_History_24 - Medical_History_32, 
        data = subset_medhist10, 
        method = "class")

training$Medical_History_10[is.na(training$Medical_History_10)] <- 
  predict(predicted_med_hist_10, training[is.na(training$Medical_History_10)])

predicted_med_hist_15 <- 
  rpart(Medical_History_15 ~ . - Medical_History_24 - Medical_History_32, 
        data = subset_medhist10, 
        method = "class")

training$Medical_History_15[is.na(training$Medical_History_15)] <- 
  predict(predicted_med_hist_15, training[is.na(training$Medical_History_15)])

predicted_med_hist_24 <- 
  rpart(Medical_History_24 ~ . - Medical_History_32, 
        data = subset_medhist10, 
        method = "class")

training$Medical_History_24[is.na(training$Medical_History_24)] <- 
  predict(predicted_med_hist_24, training[is.na(training$Medical_History_24)])

predicted_med_hist_32 <- 
  rpart(Medical_History_32 ~ . , 
        data = subset_medhist10, 
        method = "class")

training$Medical_History_32[is.na(training$Medical_History_32)] <- 
  predict(predicted_med_hist_32, training[is.na(training$Medical_History_32)])

tree_1 <- rpart(Response ~ . , data = training, method = "class")

fancyRpartPlot(tree_1)

training$Total_Medical_Keywords <- rowSums(subset(training, select = 80:127))

training_omit_repeat <- subset(training, select = -(80:127))

training_omit_nonessential <- subset(training_omit_repeat, select = -(1:8))

response_model_rf <- randomForest(as.factor(Response) ~ . , 
                                  data = training_omit_nonessential, nodesize = 1000,
                                  do.trace = TRUE)

importances <- order(response_model_rf$importance)

training_important <- subset(training_omit_nonessential, 
                             select = c(14, 18, 24, 37:39, 41:42, 44, 47, 49:52,
                                        55:57, 59, 61, 64:68, 71, 72, 73))

response_model_rf2 <- randomForest(as.factor(Response) ~ . ,
                                   data = training_important, do.trace = T)

testing$Total_Medical_Keywords <- rowSums(subset(testing, select = 80:127))

testing_omit_repeat <- subset(testing, select = -(80:127))

testing_omit_nonessential <- subset(testing_omit_repeat, select = -(1:8))

testing_important <- subset(testing_omit_nonessential, 
                             select = c(14, 18, 24, 37:39, 41:42, 44, 47, 49:52,
                                        55:57, 59, 61, 64:68, 71, 72, 73))

testing$Response <- predict(response_model_rf2, testing)

#Write rf solution to CSV
rf_solution <- data.frame(Id = testing$Id, Response = testing$Response)
write.csv(rf_solution, file = "rf_solution.csv", row.names = F)
